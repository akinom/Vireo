*{ 
   This is the export format for the DSpace Simple Archive Format. Really, this
   is two templates in one: dublin_core.xml, metadata_pu.xml,
   metadata_local.xml, and the contents file. They have just been placed in
   this one file to keep things cleaner on the filesystem. For more information
   about the format see the DSpace documentation: 
   
   https://wiki.duraspace.org/display/DSDOC18/Importing+and+Exporting+Items+via+Simple+Archive+Format 
   
   Note: be carefull about white space when editing around the content's file
   section. Since the format is not xml white space does matter.  
}*
#{if "contents".equals(template) }
#{if sub.getPrimaryDocument() != null }
${ sub.getPrimaryDocument().getName() }	bundle:CONTENT	primary:true
#{/if}
#{list items:sub.getAttachmentsByType(org.tdl.vireo.model.AttachmentType.SUPPLEMENTAL,org.tdl.vireo.model.AttachmentType.SOURCE), as:'attachment'}
${ attachment.getName() }	bundle:CONTENT
#{/list}
#{list items:sub.getAttachmentsByType(org.tdl.vireo.model.AttachmentType.LICENSE), as:'attachment'}
${ attachment.getName() }	bundle:LICENSE
#{/list}
#{/if}
#{elseif "dublin_core.xml".equals(template) }
<?xml version="1.0" encoding="utf-8"?>
<dublin_core>

    <!-- dc.contributor.author = Student -->
    <dcvalue element="contributor" qualifier="author">
        ${ sub.getStudentFormattedName(org.tdl.vireo.model.NameFormat.LAST_FIRST_MIDDLE_BIRTH)?.escapeXml()?.raw() }
    </dcvalue>

    <!-- dc.title = Document Title -->
    #{if sub.getDocumentTitle() != null } 
    <dcvalue element="title">
        ${ sub.getDocumentTitle()?.escapeXml()?.raw() }
    </dcvalue>
    #{/if}
    
    <!-- dc.description.abstract = Document Abstract -->
    #{if sub.getDocumentAbstract() != null } 
    <dcvalue element="description" qualifier="abstract">
        ${ sub.getDocumentAbstract()?.escapeXml()?.raw() }
    </dcvalue>
    #{/if}

    #{list items:sub.getCommitteeMembers(), as:'member'}
    <!-- dc.contributor.advisor = Committee Memmbers who are flagged as chair (may be multiple) -->
    #{if member.hasRole("Chair","Co-Chair","Supervisor","Co-Supervisor","Advisor") }
    <dcvalue element="contributor" qualifier="advisor">
        ${ member.getFormattedName(org.tdl.vireo.model.NameFormat.LAST_FIRST_MIDDLE_BIRTH)?.escapeXml()?.raw() }
    </dcvalue>
    #{/if}
    #{/list}
    
    
    #{list items:sub.getCommitteeMembers(), as:'member'}
    #{if member.hasNoRole() }
    <!-- dc.contributor.advisor = Committee Members who are not flagged as chair (maybe multiple) -->
    <dcvalue element="contributor" qualifier="advisor">
        ${ member.getFormattedName(org.tdl.vireo.model.NameFormat.LAST_FIRST_MIDDLE_BIRTH)?.escapeXml()?.raw() }
    </dcvalue>
    #{/if}
    #{/list}

    <!-- dc.date.created = Submission date in "YYYY-MM-dd" format -->
    <dcvalue element="date" qualifier="created">
        ${sub.getSubmissionDate().format("yyyy-MM-dd")}
    </dcvalue>
    
    <!-- dc.format.mimetype = Primary Document's mimetype, almost always "application/pdf" -->
    #{if sub.getPrimaryDocument() != null } 
    <dcvalue element="format" qualifier="mimetype">
        ${ sub.getPrimaryDocument().getMimeType()?.escapeXml()?.raw() }
    </dcvalue>
    #{/if}
    
    <!-- dc.language.iso = Document Language -->
    #{if sub.getDocumentLanguage() != null }
    <dim:field mdschema="dc" element="language" qualifier="iso">${sub.getDocumentLanguage()}</dim:field>
    #{/if}
    
    <!-- dc.type.material = "Princeton University Senior Theses" /constant-->
    <dcvalue element="type">Princeton University Senior Theses</dcvalue>

    <!-- dc.description.provenance = License Agreement Date -->
	#{if sub.getLicenseAgreementDate() != null}
       <dcvalue element="description" qualifier="provenance">
		    The student, ${ sub.getStudentFormattedName(org.tdl.vireo.model.NameFormat.FIRST_LAST)?.escapeXml()?.raw() }, accepted the attached license on ${ sub.getLicenseAgreementDate().format("yyyy-MM-dd 'at' HH:mm") }. 
       </dcvalue>
	#{/if}
		
    <!-- dc.description.provenance = Submission Date -->
	#{if sub.getSubmissionDate() != null}
       <dcvalue element="description" qualifier="provenance">
		    The student, ${ sub.getStudentFormattedName(org.tdl.vireo.model.NameFormat.FIRST_LAST)?.escapeXml()?.raw() }, submitted this ${ sub.getDocumentType() == null ? "document" : sub.getDocumentType()?.escapeXml()?.raw() } for approval on ${ sub.getSubmissionDate().format("yyyy-MM-dd 'at' HH:mm") }. 
       </dcvalue>
	#{/if}

    <!-- dc.description.provenance = Approval Date -->
	#{if sub.getApprovalDate() != null}
       <dcvalue element="description" qualifier="provenance">
		    This ${ sub.getDocumentType() == null ? "document" : sub.getDocumentType()?.escapeXml()?.raw() } was approved for publication on ${ sub.getApprovalDate().format("yyyy-MM-dd 'at' HH:mm") }. 
       </dcvalue>
	#{/if}
    
    <!-- dc.description.provenance = Statement about when this package was generated. -->
    <dcvalue element="description" qualifier="provenance">
            DSpace METS Submission Ingestion Package generated from Vireo submission #${ sub.getId() } on ${ new java.util.Date().format("yyyy-MM-dd 'at' HH:mm:ss") }
    </dcvalue>
    
</dublin_core>
#{/elseif}
#{elseif "metadata_pu.xml".equals(template) }
<?xml version="1.0" encoding="utf-8"?>
<dublin_core schema="pu">
    <!-- pu.department == Degree -->
    #{if sub.getDepartment() != null }
    <dcvalue element="department">
        ${ sub.getDepartment()?.escapeXml()?.raw() }
    </dcvalue>
    #{/if}

    <!-- pu.certificate == Degree -->
    #{if sub.getProgram() != null }
    <dcvalue element="certificate">
        ${ sub.getProgram()?.escapeXml()?.raw() }
    </dcvalue>
    #{/if}

    <!-- submitters aka students  institutional id  -->
    #{if sub.getSubmitter() != null && sub.getSubmitter().getInstitutionalIdentifier() != null }
    <dcvalue element="contributor" qualifier="authorid">
        ${ sub.getSubmitter().getInstitutionalIdentifier()?.escapeXml()?.raw() }
    </dcvalue>
    #{/if}
    

    
</dublin_core>
#{/elseif}
#{elseif "metadata_local.xml".equals(template) }
<?xml version="1.0" encoding="utf-8"?>
<dublin_core schema="local">
	<!-- local.embargo.terms and lift-->
	#{if sub.getEmbargoTypeByGuarantor(org.tdl.vireo.model.EmbargoGuarantor.DEFAULT) != null && sub.getEmbargoTypeByGuarantor(org.tdl.vireo.model.EmbargoGuarantor.DEFAULT).getDuration() != null && sub.getEmbargoTypeByGuarantor(org.tdl.vireo.model.EmbargoGuarantor.DEFAULT).getDuration() != 0 } 
	%{
	    // Calculate the embargo lift date.
	    java.util.Calendar cal = java.util.Calendar.getInstance();
	    
	    if (sub.getGraduationYear() != null) {
	        cal.clear();
	        cal.set(java.util.Calendar.YEAR, sub.getGraduationYear());
	        if (sub.getGraduationMonth() != null)
	            cal.set(java.util.Calendar.MONTH,sub.getGraduationMonth());
	    }
	    
	    cal.add(java.util.Calendar.MONTH, sub.getEmbargoTypeByGuarantor(org.tdl.vireo.model.EmbargoGuarantor.DEFAULT).getDuration());
	    java.util.Date liftDate = cal.getTime();
	}% 
	<dcvalue element="embargo" qualifier="terms">
	    ${ liftDate.format("yyyy-MM-dd") }
	</dcvalue>
	<dcvalue element="embargo" qualifier="lift">
	    ${ liftDate.format("yyyy-MM-dd") }
	</dcvalue>
	#{/if} 
</dublin_core>		
#{/elseif}
#{else}
This file, ${template}, is not supported by the DSpace Simple Archive format.
#{/else}
